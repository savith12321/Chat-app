<DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js" integrity="sha384-KAZ4DtjNhLChOB/hxXuKqhMLYvx3b5MlT55xPEiNmREKRzeEm+RVPlTnAn0ajQNs" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown.js/0.5.0/markdown.min.js" integrity="sha512-kaDP6dcDG3+X87m9SnhyJzwBMKrYnd2tLJjGdBrZ9yEL8Zcl2iJRsPwylLkbd2g3QC5S8efV3sgwI5r73U0HnA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <title>Chat App</title>
</head>
<body>
    <div class="online-bar bg-dark"><center><h1 class="online_title">online</h1></center><br><center><div class="online_bar"></div></div></center></div>
    <div id="message_container"></div>
    <div class="input-group dock-bottom">
        <input type="text" class="form-control" placeholder="Type a Message To Send" id='message_input'>
        <button class="btn btn-outline-secondary" type="button" id="button-addon2" onclick="sendMessage()">Send</button>
    </div>
    <script>
        window.addEventListener('beforeunload', function () {
            socket.emit("disconnected", "lol")
        }, false);
        const name = prompt("Please type a user name");

        if (name == undefined || name == null) {
            window.location = "/error?message=the user name cant be null";
        }else if ( name.toLowerCase().indexOf("|") != -1 ) {
            window.location = "/error?message=the user name contains invalid character \"|\"";
        }

        const socket = io.connect("http://localhost:3000")
        socket.emit("online_bar_add", name)

        document.addEventListener("keyup", function(event) {
            if (event.keyCode === 13) {
                sendMessage();
            }
        });
        socket.on("message", (data) =>{
            html_content = markdown.toHTML( data );
            document.getElementById("message_container").innerHTML += html_content;
        });
        socket.on("disconnected", (data) =>{
            document.getElementById(data).remove();
        })
        socket.on("online_bar_add", (data) =>{
            var name = data.split("|")[0]
            var id = data.split("|")[1]

            var online_bar = document.querySelector(".online_bar").innerHTML += `<h6 id="${id}">${name}</h6>`;
        });
        const sendMessage = () =>{  
            const input_box = document.getElementById("message_input");
            const message_to_send = input_box.value;
	    if (message_to_send == null || message_to_send == undefined || message_to_send == "") return
	    input_box.value = "";

            socket.emit("message", `${name}: ${message_to_send}`)
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fruktur&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Satisfy&display=swap');
    	.dock-bottom{
    	    position: fixed;
    	    bottom: 0;
    	    padding-bottom: 2px;
    	}
        .online-bar{
            height: 94.6vh;
            width: 200px;
            position: fixed;
            right: 0;
            color: white;
        }
        .online_title{
            font-family: Satisfy;
        }
        body::-webkit-scrollbar {
            width: 16px;
        }
        body::-webkit-scrollbar-thumb {
            height: 56px;
            border-radius: 8px;
            border: 4px solid transparent;
            background-clip: content-box;
            background-color: var(--yt-spec-text-secondary);
        }

    </style>
</body>
</html>

